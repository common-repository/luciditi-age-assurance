/* (c) 2024 Luciditi Age Assurance - https://luciditi.co.uk/ */
!function(t,o){"use strict";const n={started:null,type:null,sessionId:null,sessionType:null,init:()=>{n.initActions();n.initEvents()},initActions:async()=>{n.type=t("#luciditi-box").attr("data-type");n.setSessionId(t("#luciditi-box").attr("data-id"));if(new URLSearchParams(window.location.search).has("resetagecheck")){var e=new URL(window.location.href),i=new URLSearchParams(e.search);await n.ajaxResetSession();await window.LuciditiSdk.deleteCompletedFlows(o.api_url);i.delete("resetagecheck");e.search=i.toString();window.history.replaceState({},"",e);"woocommerce"===o.mode&&""!==o.shop_url?window.location.href=o.shop_url:window.location.reload()}if("disallowed"!==n.type&&"failed-validation"!==n.type){let e=new URL(o.callback_url),i=t("#luciditi-box").attr("data-min-age")||o.min_age;window.LuciditiSdk.completedAgeAssuranceFlow(i,o.api_url,{url:e.searchParams.append("luciditi_aa_precheck",!0),id:n.sessionId}).then(e=>{e?n.ajaxValidateExternalSession(i).then(e=>{location.reload()}).catch(e=>{console.error(e);t("#luciditi-loader").removeClass("active")}):t("#luciditi-loader").removeClass("active")}).catch(e=>{console.error(e);t("#luciditi-loader").removeClass("active")})}},initEvents:()=>{t("body").find(".luciditi-init-button").click(n.startVerification);t("body").find(".luciditi-self-declare-default").click(n.setFailedVerification)},startVerification:async i=>{i.preventDefault();i=t(i.currentTarget);t(i).addClass("active");t(i).attr("disabled","disabled");try{if(!0!==n.started){var e=await n.maybeAuthenticate();console.log("%cStartVerification => session","color:red;font-family:system-ui;-webkit-text-stroke: 1px black;font-weight:bold");console.log(e);await window.LuciditiSdk.initializeSdk(o.api_url,e);var s=await window.LuciditiSdk.sessionIsValid();console.log("%cStartVerification => isSessionValid","color:red;font-family:system-ui;-webkit-text-stroke: 1px black;font-weight:bold");console.log(s);if(0==s){e=await n.maybeAuthenticate(!0);await window.LuciditiSdk.initializeSdk(o.api_url,e)}var a=await n.getStartupToken();console.log("%cStartupToken => startupToken","color:red;font-family:system-ui;-webkit-text-stroke: 1px black;font-weight:bold");console.log(a);t('meta[name="luciditi-startup-token"]').attr("content",a);n.started=!0}n.initVerificationModal();t(i).removeClass("active");t(i).removeAttr("disabled")}catch(e){"object"==typeof e&&"message"in e?alert(e.message):alert(e);console.error(e);t(i).removeClass("active");t(i).removeAttr("disabled")}},setFailedVerification:async e=>{e.preventDefault();t("#luciditi-loader").addClass("active");await n.ajaxSetTmpSessionStateToFailed();location.reload()},setSessionId:e=>{n.sessionId=e;n.sessionId.startsWith("tmp_")?n.sessionType="tmp_session":n.sessionId.includes("_")?n.sessionType="failed_session":n.sessionId.includes("-")&&(n.sessionType="valid_session")},maybeAuthenticate:(e=!1)=>"tmp_session"!=n.sessionType&&"failed_session"!=n.sessionType||0!=e?(console.log("ajaxAuth trigger"),n.ajaxAuth()):(console.log("ajaxGetTempSession trigger"),n.ajaxGetTempSession()),getStartupToken:async()=>{var e=await n.ajaxGetSignUpData(),i=new URL(o.callback_url);console.log("%cGetStartupToken => signupData","color:green;font-family:system-ui;-webkit-text-stroke: 1px black;font-weight:bold");console.log(e);i.searchParams.append("luciditi_aa",n.sessionId);let s=await window.LuciditiSdk.addSignupCode({callbackUrl:i.href,signupType:window.LuciditiSdk.SignupType,stepUpWithData:"yes"==e.stepup_with_id,stepUpWithIdDocument:"yes"==e.stepup_with_data,requiredAge:e.min_age,callerUserName:e.caller_username},!0);console.log("%cGetStartupToken => startupToken","color:green;font-family:system-ui;-webkit-text-stroke: 1px black;font-weight:bold");console.log(s);i=s.Signup.CodeId||!1,e=e.min_age||!1;await n.ajaxSaveTmpSessionCodeId(i,e);return new Promise((e,i)=>{s.StartupToken?e(s.StartupToken):i(o.startup_token_error)})},initVerificationModal:()=>{var e=document.getElementById("luciditi-age-assurance-modal");window.LuciditiSdk.registerVerificationEventCallbacks(()=>{console.log("Verification started")},()=>{console.log("Verification completed");t(".luciditi-init-button").replaceWith('<div class="loading"><div class="loading__bar"></div ></div>');t(".luciditi-self-declare").hide();t(".luciditi-modal").hide();t("body").removeClass("luciditi-modal-opened");location.reload()},()=>{console.log("Verification failed");t(".luciditi-modal").hide();t("body").removeClass("luciditi-modal-opened");alert(o.verification_failed)},async()=>{console.log("Verification aborted");t(".luciditi-modal").hide();t("body").removeClass("luciditi-modal-opened");t("#luciditi-loader").addClass("active");if(0<t(".luciditi-self-declare-default").length)t(".luciditi-self-declare-default").trigger("click");else if(0<t(".luciditi-self-declare").length)window.location.href=t(".luciditi-self-declare").attr("href");else{await n.ajaxSetTmpSessionStateToFailed();location.reload()}},e=>{console.log("Verification error");console.log(e)});window.LuciditiSdkUI.startVerification();document.body.classList.add("luciditi-modal-opened");e.style.display="block";var i=e.getElementsByClassName("close-reveal-modal");for(let e=0;e<i.length;e++)i[e].onclick=function(e){e.currentTarget.closest(".luciditi-modal").style.display="none";document.body.classList.remove("luciditi-modal-opened")}},ajaxResetSession:()=>new Promise((i,a)=>{t.ajax({data:{action:"luciditi_aa_reset_session",session_id:n.sessionId},type:"POST",url:o.ajax_url,success:function(e){(e.success?i:a)(e.message)},error:function(e,i,s){a(o.server_error)}})}),ajaxValidateExternalSession:e=>new Promise((i,a)=>{t.ajax({data:{action:"luciditi_aa_validate_external_session",session_id:n.sessionId,verified_age:e},type:"POST",url:o.ajax_url,success:function(e){(e.success?i:a)(e.message)},error:function(e,i,s){a(o.server_error)}})}),ajaxAuth:()=>new Promise((i,a)=>{t.ajax({data:{action:"luciditi_aa_api_auth",session_id:n.sessionId},type:"POST",url:o.ajax_url,success:function(e){if(e.success){"session_failed"!==n.sessionType&&"sessionId"in e.session&&n.setSessionId(e.session.sessionId);i(e.session)}else a(e.message)},error:function(e,i,s){a(o.server_error)}})}),ajaxGetTempSession:()=>new Promise((i,a)=>{t.ajax({data:{action:"luciditi_aa_get_tmp_session",session_id:n.sessionId},type:"POST",url:o.ajax_url,success:function(e){if(e.success){"session_failed"!==n.sessionType&&"sessionId"in e.session&&n.setSessionId(e.session.sessionId);i(e.session)}else a(e.message)},error:function(e,i,s){a(o.server_error)}})}),ajaxGetSignUpData:()=>new Promise((i,a)=>{t.ajax({data:{action:"luciditi_aa_get_signup_data"},type:"POST",url:o.ajax_url,success:function(e){e.success?i(e.data):a(e.message)},error:function(e,i,s){a(o.server_error)}})}),ajaxSaveTmpSessionCodeId:(e,s)=>new Promise((i,a)=>{t.ajax({data:{action:"luciditi_aa_save_temp_session_codeid",session_id:n.sessionId,code_id:e,min_age:s},type:"POST",url:o.ajax_url,success:function(e){e.success?i():a(e.message)},error:function(e,i,s){a(o.server_error)}})}),ajaxSetTmpSessionStateToFailed:()=>new Promise((i,a)=>{"session_failed"==n.sessionType&&i();t.ajax({data:{action:"luciditi_aa_set_session_state_failed",session_id:n.sessionId},type:"POST",url:o.ajax_url,success:function(e){e.success?i():a(e.message)},error:function(e,i,s){a(o.server_error)}})})};t(document).ready(()=>{0<t("#luciditi-age-assurance").length&&n.init()})}(jQuery,luciditi_aa_strings);